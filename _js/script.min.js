$(document).ready(function(){if(w=$("div.main_chart").width(),h=440,break1=575,break2=388,smallW=$("div.major div.article div.small_chart").width(),smallH=$("div.major div.article div.small_chart").height(),navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/IEMobile/i))var b=!0;else var b=!1;d3.csv("_data/Undergrad_Degrees_012814.csv",function(c){function d(a){return a.values[a.values.length-1][1]}function e(a){C.attr("width",A+z.left+z.right).attr("height",B+z.top+z.bottom),D.attr("class","chart inactive").attr("transform","translate("+z.left+","+z.top+")"),E.domain(break1>A?[new Date(2007,0,1),new Date(2013,0,1)]:[new Date(2003,0,1),new Date(2013,0,1)]),F.domain([0,s(a)]),D.append("clipPath").attr("id","main_chart_area").append("rect").attr("width",A).attr("height",B).attr("fill","grey");{var b=D.selectAll(".major").data(a).enter().append("g").attr("class","major").attr("data-major",function(a){return a.major}).attr("data-school",function(a){return a.school}).on("click",function(b){option=$('option[value="'+b.major+'"]'),Z.items.indexOf(b.major)<0?(Z.update({selected:b.major}),option.prop("selected",!0)):(Z.update({deselected:b.major}),option.prop("selected",!1)),select.trigger("chosen:updated"),o(a)}).on("mouseover",function(a){b.append("text").attr("class","tooltip").text(a.major).attr("text-anchor","end").attr("x",A)}).on("mouseout",function(){b.select(".tooltip").remove()}),c=(b.append("path").attr("class","line line1").attr("d",function(a){return I(a.values)}).attr("clip-path","url(#main_chart_area)").attr("stroke",function(){return purple}).attr("opacity",.5).attr("stroke-width",1.2),b.append("path").attr("class","line line2").attr("d",function(a){return I(a.values)}).attr("clip-path","url(#main_chart_area)").attr("stroke",function(){return"yellow"}).attr("opacity",0).attr("stroke-width",5).attr("stroke-opacity",0),b.append("g").attr("class","line-points").attr("display","none").attr("fill",purple).attr("opacity",0));c.selectAll("circle").data(function(a){return a.values}).enter().append("circle").attr("cx",function(a){return E(a[0])}).attr("cy",function(a){return F(a[1])}).attr("r",2.5)}D.append("g").attr("class","x axis").attr("transform","translate(0,"+B+")").call(G),D.append("g").attr("class","y axis").call(H).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Degrees Awarded")}function f(a){function b(a){return a.major}var c=200,d="linear",e=D.transition().duration(c).attr("class",function(){return Y.activeItemsExist?"chart active":"chart inactive"}).ease(d);F.domain([0,Y.upperDomain]),e.select(".y.axis").call(H);var f=D.selectAll(".major").data(a,b).order();f.transition().duration(c).ease(d).attr("class",function(a){return Y&&!Y.activeItemsExist?"major":1==a.active?"major active":"major inactive"});var g=f.selectAll(".line1").order(),h=f.selectAll(".line2").order();g.transition().duration(c).ease(d).attr("d",function(a){return I(a.values)}).attr("stroke",function(a){return a.color?a.color:purple}).attr("stroke-width",function(a){return a.color?2.5:1.2}).attr("opacity",function(a){return Y&&!Y.activeItemsExist?.5:a.active?1:.1}),h.transition().duration(c).ease(d).attr("d",function(a){return I(a.values)});var i=f.selectAll(".line-points");i.transition().duration(c).ease(d).attr("display",function(a){return a.active?"inline":"none"}).attr("fill",function(a){return a.color?a.color:purple}).attr("opacity",function(a){return a.active?1:0}).attr("r",function(a){return a.active?5:2.5});var j=i.selectAll("circle").data(function(a){return a.values});j.transition().duration(c).ease(d).attr("cx",function(a){return E(a[0])}).attr("cy",function(a){return F(a[1])}),$(".search-choice").each(function(){text=$(this).text();for(var b=a.length-1;b>=0;b--)color=d3.rgb(a[b].color),a[b].major==text&&$(this).css({"background-color":color,color:color.brighter(4)})})}function g(b){C.attr("width",K+J.left+J.right).attr("height",(N+M)*u(b)+J.top+J.bottom),D.data(b).attr("width",K).attr("height",(N+M)*u(b)).attr("class","chart").attr("transform","translate("+J.left+","+J.top+")"),O.domain([0,t(b)]),D.append("g").attr("class","b axis").call(P);{var c=D.selectAll(".major").data(b).enter().append("g").filter(function(b){return a=d(b),0!=a}).sort(function(a,b){return d3.descending(d(a),d(b))}).attr("class","major").attr("data-major",function(a){return a.major}).attr("data-school",function(a){return a.school}).attr("transform",function(a,b){return"translate(0,"+b*(N+M)+")"});c.append("rect").attr("class","bground").attr("width",L).attr("height",N).attr("fill","white"),c.append("rect").attr("class","bar").attr("width",function(a){return O(d(a))}).attr("height",N).attr("fill","purple").attr("opacity",.4),c.append("text").attr("class","name").attr("x",function(){return L-J.left-J.right}).attr("y",N/2).attr("dy",".35em").attr("text-anchor","end").attr("fill","black").attr("font-weight","bold").text(function(a){return a.major}),c.append("text").attr("class","number").attr("x",function(){return 5}).attr("y",N/2).attr("dy",".35em").attr("fill","black").attr("font-weight","normal").text(function(a){return d(a)})}}function i(a){var b=0,c="linear",e=D.transition().duration(b).ease(c);O.range([0,K]),e.select(".b.axis").call(P);var f=D.selectAll(".major").data(a);f.transition().duration(b).ease(c);var g=f.selectAll(".bground").attr("class","bground");g.transition().duration(b).ease(c).attr("width",L);var h=f.selectAll(".bar");h.transition().duration(b).ease(c).attr("class","bar").attr("width",function(a){return O(d(a))});var i=f.selectAll("text.name");i.transition().duration(b).ease(c).attr("class","name").attr("x",function(){return L-5-5}).attr("y",N/2);var j=f.selectAll("text.number");j.transition().duration(b).ease(c).attr("class","number").attr("x",function(){return 5}).attr("y",N/2).text(function(a){return d(a)})}function j(b){articles=d3.selectAll("div.article").each(function(c,d){self=this,m=d3.select(this).attr("data-major"),m=m.split(","),small_dataset=[];for(var d=b.length-1;d>=0;d--)index=m.indexOf(b[d].major),index>=0&&small_dataset.push(b[d]);small_dataset=k(small_dataset);for(var e=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b"],d=0;d<=small_dataset.length-1;d++)small_dataset[d].color=small_dataset.length>1?e[d]:purple;T.range([0,R]),U.rangeRound([S,0]),a=s(small_dataset),U.domain([0,a]),C=d3.select(this).selectAll("div.small_chart").append("svg").attr("width",R+Q.left+Q.right).attr("height",S+Q.top+Q.bottom),small_chart=C.append("g").attr("class","small_chart").attr("transform","translate("+Q.left+","+Q.top+")"),small_chart.append("clipPath").attr("id","chartarea").append("rect").attr("width",R).attr("height",S).attr("fill","grey");{var f=small_chart.selectAll(".major").data(small_dataset).enter().append("g").attr("class","major").attr("data-major",function(a){return a.major}).attr("data-school",function(a){return a.school}),g=(f.append("path").attr("class","line").attr("d",function(a){return X(a.values)}).attr("clip-path","url(#chartarea)").attr("stroke",function(a){return a.color}).attr("fill","none").attr("stroke-width",1.2),f.append("g").attr("class","line-points").attr("fill",function(a){return a.color}));g.selectAll("circle").data(function(a){return a.values}).enter().append("circle").attr("cx",function(a){return T(a[0])}).attr("cy",function(a){return U(a[1])}).attr("r",2.5)}if(V.tickFormat(375>smallW?smallDate:fullDate),small_chart.append("g").attr("class","smX axis").attr("transform","translate(0,"+S+")").call(V),small_chart.append("g").attr("class","smY axis").call(W).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("Degrees Awarded"),small_dataset.length>1){key=d3.select(this).select("div.articlechart").append("div").attr("class","key");for(var d=0;d<=small_dataset.length-1;d++){var h=key.selectAll(".item").data(small_dataset).enter().append("div").attr("class","item");box=h.append("div").attr("class","box").style("background-color",function(a){return a.color}),p=h.append("p").text(function(a){return a.major})}}})}function k(a){for(var b=a.length-1;b>=0;b--)"Computer Science"==a[b].major&&(a[b].major="Computer Science (Degrees Awarded)",data={major:"Computer Science (Declared Majors)",values:[[new Date(2008,0,1),61],[new Date(2009,0,1),78],[new Date(2010,0,1),91],[new Date(2011,0,1),83],[new Date(2012,0,1),109],[new Date(2013,0,1),156]]},a.push(data));return a}function l(){this.items=[]}function n(a){for(var b=d3.nest().key(function(a){return a.school}).entries(a),c=[],d=0;d<b.length;d++){var e=b[d].key,e=x(e),f="<optgroup label='"+e+"'>";c.push(f);for(var g=0;g<b[d].values.length;g++)major=b[d].values[g].major,option="<option value='"+major+"'>"+major+"</option>",c.push(option);c.push("</optgroup>")}select.html(c.join("")),select.trigger("chosen:updated"),select.on("change",function(b,c){Z.update(c),o(a)})}function o(b){activeItems=[];for(var c=b.length-1;c>=0;c--)major=b[c].major,itemInFilter=Z.items.indexOf(major),itemInFilter>=0?(b[c].active=!0,activeItems.push(b[c])):b[c].active=!1;0==activeItems.length?(Y.activeItemsExist=!1,Y.upperDomain=s(y)):(Y.activeItemsExist=!0,Y.upperDomain=s(activeItems)),b.sort(function(b,c){return a=b.active,O=c.active,a===O?0:1==a?1:-1}),Z.paramaters=Y,y=r(b),f(y)}function q(){for(var a=[],b=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],c=0;c<b.length;c++){var d={color:b[c],active:!1};a.push(d)}return a}function r(a){function b(a){for(var b=0;b<colors.length;b++)colors[b].color==a&&(colors[b].active=!1)}function c(){for(var a=0;a<colors.length;a++)if(0==colors[a].active)return colors[a]}for(var d=0;d<a.length;d++)a[d].active&&a[d].color?a[d].color=a[d].color:!a[d].active&&a[d].color?(b(a[d].color),a[d].color=!1):a[d].active&&!a[d].color?(color=c(),a[d].color=color.color,color.active=!0):a[d].color=!1;return a}function s(a){yValues=[];for(var b=a.length-1;b>=0;b--)for(var c=a[b].values.length-1;c>=0;c--)yValues.push(a[b].values[c][1]);return max=d3.max(yValues),max+max/15}function t(a){yValues=[];for(var b=a.length-1;b>=0;b--){var c=a[b].values.length;yValues.push(a[b].values[c-1][1])}return max=d3.max(yValues)}function u(a){cases=[];for(var b=a.length-1;b>=0;b--)v=d(a[b]),0!=v&&cases.push(a[b]);return cases.length}function x(a){switch(a){case"02SES":return"School of Education and Social Policy";case"03JOU":return"Medill School of Journalism";case"04CAS":return"Weinberg College of Arts and Sciences";case"05MUS":return"Bienen School of Music";case"06SPC":return"School of Communication";case"07MEA":return"McCormick School of Engineering"}}var y=[];c.forEach(function(b){for(var c={school:b.school,major:b.major,active:!1,color:!1,values:[]},d=2003;2013>=d;d++)a=d.toString(),year=new Date(a,0,1),degree_count=+b[parseInt(a)],c.values.push([year,degree_count]);y.push(c)}),dataset1=y,colors=q(),purple=d3.rgb("#501F84"),$("div.main_chart").before("<div class='search'></div>"),0==b?($("div.search").append('<select data-placeholder="Search for your major and compare it to others."class="chosen-select" multiple="true"></select></div>'),select=$("select.chosen-select"),select.chosen({width:"100%",max_selected_options:10,no_results_text:"Oops, nothing found!"}),n(y)):($("div.search").append('<p class="mobile_explain"></p>'),$("p.mobile_explain").text("This graph is best viewed on a desktop so you can search for and compare majors."));var z={top:40,right:15,bottom:30,left:30},A=w-z.left-z.right,B=h-z.top-z.bottom,C=d3.select("div.main_chart").append("svg").attr("class","main_chart"),D=d3.select("svg.main_chart").append("g").classed({chart:!0});smallDate=d3.time.format("'%y"),fullDate=d3.time.format("%Y");var E=d3.time.scale().range([0,A]),F=d3.scale.linear().rangeRound([B,0]),G=d3.svg.axis().scale(E).orient("bottom"),H=d3.svg.axis().scale(F).orient("left"),I=d3.svg.line().interpolate("monotone").x(function(a){return E(a[0])}).y(function(a){return F(a[1])}).defined(function(a){return!isNaN(a[1])}),J={top:30,right:5,bottom:10,left:5},K=w-J.left-J.right,L=w-J.right-J.right,M=1,N=20,O=(d3.format("%"),d3.scale.linear().range([0,K])),P=d3.svg.axis().scale(O).orient("top"),Q={top:10,right:30,bottom:30,left:30},R=smallW-Q.left-Q.right,S=smallH-Q.top-Q.bottom,T=d3.time.scale().range([0,R]).domain([new Date(2003,0,1),new Date(2013,0,1)]),U=d3.scale.linear().rangeRound([S,0]),V=d3.svg.axis().scale(T).orient("bottom"),W=d3.svg.axis().scale(U).orient("left"),X=d3.svg.line().interpolate("monotone").x(function(a){return T(a[0])}).y(function(a){return U(a[1])}).defined(function(a){return!isNaN(a[1])}),Y={upperDomain:s(y),activeItemsExist:!1};A>break2?(D.attr("data-charttype","line"),e(y),$("p.instructions.line").show(),$("p.instructions.bar").hide()):($("div.search").hide(),D.attr("data-charttype","bar"),g(dataset1),$("p.instructions.line").hide(),$("p.instructions.bar").show()),j(y),$("p.metainfo").css("display","inline"),$(window).resize(function(){wid=$("div.main_chart").width(),A=wid-z.left-z.right,K=wid-J.left-J.right,L=wid-J.right-J.right;var a=D.attr("data-charttype");A>break2&&!b?($("div.search").show(),$("p.instructions.line").show(),$("p.instructions.bar").hide(),E.domain(break1>A?[new Date(2007,0,1),new Date(2013,0,1)]:[new Date(2003,0,1),new Date(2013,0,1)]),E.range([0,A]),d3.select("svg.main_chart .x.axis").call(G),d3.select("svg.main_chart").attr("width",A+z.left+z.right).attr("height",B+z.top+z.bottom),d3.select("svg.main_chart #main_chart_area").select("rect").attr("width",A).attr("height",B),"bar"==a?(D.selectAll("*").remove(),D.attr("data-charttype","line"),e(y)):f(y)):($("div.search").hide(),$("p.instructions.line").hide(),$("p.instructions.bar").show(),d3.select("svg.main_chart").attr("width",K+J.left+J.right).attr("height",(N+M)*u(y)+J.top+J.bottom),"line"==a?(D.selectAll("*").remove(),D.attr("data-charttype","bar"),g(dataset1)):i(dataset1)),smallW=$("div.article div.small_chart").width(),smallH=$("div.article div.small_chart").height(),R=smallW-Q.right-Q.left,S=smallH-Q.top-Q.bottom,smCh=d3.selectAll("div.small_chart"),smCh.selectAll("*").remove(),smKey=d3.selectAll("div.key"),smKey.remove(),j(y)}),l.prototype.update=function(a){if(a.selected&&this.items.push(a.selected),a.deselected){var b=this.items.indexOf(a.deselected);this.items.splice(b,1)}};var Z=new l}),$navWrap=$("div.navwrapper"),$navWrap.waypoint("sticky"),$article=$("div.major"),$navItems=$("nav ul li a"),$current=$("p.current"),$article.waypoint(function(){for(var a=$(this),b=a.attr("id"),c=$("div.major#"+b+"> h3").html(),d=$navItems.length-1;d>=0;d--)$item=$($navItems[d]),link=$item.attr("href").substr(1),link==b?($item.addClass("active"),$current.text(c)):$item.removeClass()}),$navToggle=$("#navToggle"),$nav=$("nav"),$navToggle.click(function(){$nav.toggleClass("active"),$nav.toggleClass("opened"),$nav.hasClass("opened")&&$navItems.click(function(){$nav.removeClass("active"),$nav.removeClass("opened")})}),$navItems.click(function(){$this=$(this),$this.addClass("active")})});